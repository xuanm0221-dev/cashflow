# 분석 내용 편집 기능 사용 가이드

## 개요
연간 자금계획 탭의 "설명과 분석" 섹션에 편집 기능이 추가되었습니다. PIN 인증 후 자동 생성된 분석 내용을 수정하고 저장할 수 있습니다.

## 설정 방법

### 1. 환경변수 설정

`.env.local` 파일을 생성하고 다음 내용을 추가하세요:

```bash
# 편집 모드 PIN (원하는 숫자로 변경)
EDIT_PIN=1234

# Vercel KV는 Vercel 대시보드에서 자동 설정됩니다
```

### 2. Vercel KV 설정 (배포용)

#### 로컬 개발
1. Vercel 프로젝트에서 Storage 탭으클릭
2. "Create Database" → "KV" 선택
3. 데이터베이스 이름 입력 후 생성
4. `.env.local` 탭에서 환경변수 복사하여 로컬 `.env.local`에 추가

#### Vercel 배포
1. Vercel 대시보드 → 프로젝트 선택
2. Settings → Environment Variables
3. `EDIT_PIN` 추가 (원하는 PIN 번호)
4. KV Storage는 자동으로 연결됨

## 사용 방법

### 편집 모드 활성화
1. 연간 자금계획 탭에서 우측 상단의 "편집 모드 켜기 🔓" 버튼 클릭
2. PIN 입력 (기본값: 1234)
3. 인증 성공 시 편집 모드 활성화

### 내용 편집
편집 모드에서 다음 섹션을 수정할 수 있습니다:

- **핵심 인사이트**: 각 항목 수정, 추가, 삭제
- **현금흐름표/운전자본표 상세**: 금액은 자동 생성, 설명 부분만 편집
- **운전자본표 인사이트**: 매출채권, 재고자산, 매입채무 설명 수정
- **리스크 요인**: 항목 추가, 수정, 삭제
- **관리 포인트**: 항목 추가, 수정, 삭제
- **CFO 주요 질문**: 질문과 답변 수정, 추가, 삭제

### 저장 및 초기화
- **저장**: 우측 상단의 "저장" 버튼 클릭
- **초기화**: 저장된 내용을 삭제하고 자동 생성된 내용으로 복원
- **편집 모드 끄기**: 편집을 취소하고 보기 모드로 전환

## 데이터 저장 방식

- 수정된 내용은 **Vercel KV**에 연도별로 저장됩니다
- 키 형식: `analysis:2025`, `analysis:2026`
- 저장된 내용이 있으면 자동 생성된 내용 대신 저장된 내용이 표시됩니다
- 연도를 변경하면 해당 연도의 저장된 내용을 불러옵니다

## 보안

- PIN은 환경변수로 관리되며 코드에 하드코딩되지 않습니다
- 인증 토큰은 1시간 동안 유효합니다
- 토큰은 브라우저의 localStorage에 저장됩니다
- 편집/저장 시 서버에서 토큰을 검증합니다

## API 엔드포인트

### POST `/api/auth/pin`
PIN 인증 및 토큰 발급

**요청:**
```json
{
  "pin": "1234"
}
```

**응답:**
```json
{
  "success": true,
  "token": "base64_token",
  "message": "인증되었습니다."
}
```

### GET `/api/analysis?year=2026`
저장된 분석 내용 조회

**응답:**
```json
{
  "analysis": {
    "year": 2026,
    "keyInsights": ["...", "..."],
    "cfCategories": [...],
    "wcCategories": [...],
    "wcInsights": {...},
    "riskFactors": [...],
    "actionItems": [...],
    "cfoQA": [...],
    "lastModified": "2026-02-06T..."
  }
}
```

### POST `/api/analysis`
분석 내용 저장 (인증 필요)

**헤더:**
```
Authorization: Bearer {token}
```

**요청:**
```json
{
  "year": 2026,
  "analysis": {...}
}
```

### DELETE `/api/analysis?year=2026`
저장된 내용 삭제 (초기화, 인증 필요)

## 문제 해결

### PIN이 작동하지 않음
- `.env.local` 파일이 올바르게 설정되었는지 확인
- 개발 서버를 재시작 (`npm run dev`)
- Vercel 배포 시 환경변수가 설정되었는지 확인

### 저장이 되지 않음
- Vercel KV가 올바르게 설정되었는지 확인
- 브라우저 콘솔에서 에러 메시지 확인
- 토큰이 만료되었을 수 있으니 다시 로그인

### 편집 내용이 사라짐
- 저장 버튼을 클릭했는지 확인
- 편집 모드를 끄기 전에 저장해야 합니다
- 페이지를 새로고침하면 저장되지 않은 내용은 사라집니다

## 주의사항

- 편집 중에는 반드시 **저장 버튼**을 눌러야 내용이 저장됩니다
- 페이지를 새로고침하거나 다른 탭으로 이동하면 저장되지 않은 내용이 사라집니다
- 초기화는 되돌릴 수 없으니 신중하게 사용하세요
- PIN은 안전하게 관리하세요 (팀원과 공유 가능)
